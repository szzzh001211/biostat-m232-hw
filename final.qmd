---
title: "Biostat M232 Final Project"
subtitle: Due Mar 21 @ 11:59PM
author: "Ziheng Zhang_606300061"
date: today
format:
  html:
    theme: cosmo
    embed-resources: true
    number-sections: false
    toc: true
    toc-depth: 4
    toc-location: left
    code-fold: false
knitr:
  opts_chunk: 
    cache: false    
    echo: true
    fig.align: 'center'
    fig.width: 6
    fig.height: 4
    message: FALSE
execute:
  eval: true    
---

## Basic Setup
```{r}
library(tidyverse)
library(naniar)
library(visdat)
library(ggplot2)
library(mice)
library(gridExtra)
library(MASS)
set.seed(5)

```

## Data Preparation
```{r}
lead <- read.table("lead.txt")
lead[lead == -9] <- NA
col_names <- c("id", "smeltdis", "age_mo", "female", "iqf", "lead72", "lead73", 
               "fst2yrs", "totyrs", "pica", "colic", "clumsy", "irrit", 
               "convulse", "fwtap", "tap", "visreact", "audreact", "hypscore")
colnames(lead) <- col_names

lead$female <- factor(lead$female, levels = c(0,1), labels = c("Male", "Female"))
lead$fst2yrs <- factor(lead$fst2yrs, levels = c(0,1), labels = c("No", "Yes"))
lead$pica <- factor(lead$pica, levels = c(0,1), labels = c("No", "Yes"))
lead$colic <- factor(lead$colic, levels = c(0,1), labels = c("No", "Yes"))
lead$clumsy <- factor(lead$clumsy, levels = c(0,1), labels = c("No", "Yes"))
lead$irrit <- factor(lead$irrit, levels = c(0,1), labels = c("No", "Yes"))
lead$convulse <- factor(lead$convulse, levels = c(0,1), labels = c("No", "Yes"))
lead$hypscore <- factor(lead$hypscore, levels = c(0,1,2,3,4), 
                        labels = c("Never", "Seldom", "Sometimes", "Often", 
                                   "Always"), ordered = TRUE)


lead$smeltdis <- factor(lead$smeltdis, levels = c(1,2,3), 
                        labels = c("0-1 miles", "1-2.5 miles", "2.5-4.1 miles"), 
                        ordered = TRUE)
```


## Missing Data Exploration
```{r}
p <- vis_miss(lead) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5, size = 12),
        axis.text.y = element_text(size = 18),  
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))
plot(p)
# ggsave("missing_data_plot.png", 
#        p, 
#        width = 12, 
#        height = 9, 
#        dpi = 300,
#        bg = "white")

miss_var_summary(lead)
```



## Task 1

```{r}


```



## Task 2 -- Mice Imputation

```{r}

lead_mice <- mice(lead, m = 5)
lead1 <- complete(lead_mice, 1)
lead2 <- complete(lead_mice, 2)
lead3 <- complete(lead_mice, 3)
lead4 <- complete(lead_mice, 4)
lead5 <- complete(lead_mice, 5)
```

```{r}
plts <- list()

plts[[1]] <- ggplot(data = lead, aes(x = lead72)) +
  geom_histogram() + 
  theme_bw() + 
  labs(title = "Original data") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18),  
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18)
        )

plts[[2]] <- ggplot(data = lead1, aes(x = lead72)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(title = "First imputation") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18),  
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18)
        )

plts[[3]] <- ggplot(data = lead2, aes(x = lead72)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(title = "Second imputation") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18),  
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18)
        )

plts[[4]] <- ggplot(data = lead3, aes(x = lead72)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(title = "Third imputation") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18),  
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18)
        )

plts[[5]] <- ggplot(data = lead4, aes(x = lead72)) +
  geom_histogram() + 
  theme_bw() + 
  labs(title = "Fourth imputation") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18),  
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18)
        )

plts[[6]] <- ggplot(data = lead5, aes(x = lead72)) +
  geom_histogram() + 
  theme_bw() + 
  labs(title = "Fifth imputation") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18),  
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18)
        )
  
ggsave("imputation_histograms.png", 
       grid.arrange(grobs = plts, nrow = 2), 
       width = 12, 
       height = 9, 
       dpi = 300,
       bg = "white")
```


```{r}
lead_complete <- complete(lead_mice)

lead_complete <- lead_complete |>
  mutate(lead_exposure = ifelse(lead72 >= 40, "High", "Low")) |>
  mutate(lead_exposure = factor(lead_exposure, levels = c("Low", "High")))

ggplot(lead_complete, aes(x = lead_exposure, y = fwtap, fill = lead_exposure)) +
  geom_violin() +
  theme_minimal() +
  labs(title = "Violin plot of lead exposure and fwtap",
       x = "Lead exposure",
       y = "fwtap")

ggplot(lead_complete, aes(x = lead_exposure, y = tap, fill = lead_exposure)) +
  geom_violin() +
  theme_minimal() +
  labs(title = "Violin plot of lead exposure and fwtap",
       x = "Lead exposure",
       y = "tap")

ggplot(lead_complete, aes(x = lead_exposure, fill = irrit)) +
  geom_bar(position = "fill") +  
  geom_text(stat = "count", aes(label = scales::percent(..count../tapply(..count.., ..x.., sum)[..x..], accuracy = 0.1)), 
            position = position_fill(vjust = 0.5), size = 5) + 
  theme_minimal() +
  labs(title = "Proportion of Irritability by Lead Exposure", 
       x = "Lead Exposure Group", y = "Proportion",
       fill = "Irritability (1=Yes, 0=No)")

ggplot(lead_complete, aes(x = lead_exposure, fill = hypscore)) +
  geom_bar(position = "fill") +  
  geom_text(stat = "count", 
            aes(label = scales::percent(..count../tapply(..count.., ..x.., sum)[..x..], accuracy = 0.1)),
            position = position_fill(vjust = 0.5), size = 5, color = "red") + 
  theme_minimal() +
  labs(title = "Proportion of Hyperactivity Score by Lead Exposure", 
       x = "Lead Exposure Group", y = "Proportion",
       fill = "Hyperactivity Score")
```

```{r}
lead_mice_completed <- complete(lead_mice, "long", include = TRUE) |>  
  mutate(lead_exposure = ifelse(lead72 >= 40, "High", "Low"),
         lead_exposure = factor(lead_exposure, levels = c("Low", "High")))

lead_mice <- as.mids(lead_mice_completed)



fwtap_marginal <- with(lead_mice, lm(fwtap ~ lead_exposure))
summary(pool(fwtap_marginal))

fwtap_partial <- with(lead_mice, lm(fwtap ~ lead_exposure + colic + convulse + 
                                      age_mo + female))
summary(pool(fwtap_partial))



tap_marginal <- with(lead_mice, lm(tap ~ lead_exposure))
summary(pool(tap_marginal))

tap_partial <- with(lead_mice, lm(tap ~ lead_exposure + colic + convulse +
                                    age_mo + female))
summary(pool(tap_partial))
```
```{r}
irrit_marginal <- with(lead_mice, glm(irrit ~ lead_exposure, family = "binomial"))
summary(pool(irrit_marginal))

irrit_partial <- with(lead_mice, glm(irrit ~ lead_exposure + colic + convulse +
                                       age_mo + female, family = "binomial"))
summary(pool(irrit_partial))


hypscore_marginal <- with(lead_mice, polr(hypscore ~ lead_exposure, Hess = TRUE))
summary(pool(hypscore_marginal))


hypscore_partial <- with(lead_mice, polr(hypscore ~ lead_exposure + colic + convulse +
                                          age_mo + female, Hess = TRUE))
summary(pool(hypscore_partial))
exp(pool(hypscore_partial)[,3][1,3])
```

```{r}
fwtap_test <- with(lead_mice, t.test(fwtap ~ lead_exposure))

tap_test <- with(lead_mice, t.test(tap ~ lead_exposure))

irrit_test <- with(lead_mice, chisq.test(table(lead_exposure, irrit)))

hypscore_test <- with(lead_mice, wilcox.test(as.numeric(hypscore) ~ lead_exposure))
```



